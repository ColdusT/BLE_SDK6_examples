From a3857a2b744775f79ef5007b665e30b23b682522 Mon Sep 17 00:00:00 2001
From: Moh Nikaeen <m.h.nickaeen@gmail.com>
Date: Mon, 13 Mar 2023 11:10:38 +0100
Subject: [PATCH] Take a look at this modified SDK6 compatible with
 Multirole_con_periph example

---
 projects/BLE_SDK6_examples                    |  1 +
 sdk/app_modules/api/app.h                     | 15 +++++++-
 sdk/app_modules/api/app_task.h                |  7 ++--
 sdk/app_modules/src/app_common/app_task.c     |  4 +--
 .../src/app_easy/app_easy_msg_utils.c         |  2 +-
 .../da1458x_periph_setup.h                    |  2 +-
 .../misc/da14531_symbols.txt                  | 36 +++++++++----------
 7 files changed, 42 insertions(+), 25 deletions(-)
 create mode 160000 projects/BLE_SDK6_examples

diff --git a/sdk/app_modules/api/app.h b/sdk/app_modules/api/app.h
index aaaca5a..c334c3c 100644
--- a/sdk/app_modules/api/app.h
+++ b/sdk/app_modules/api/app.h
@@ -113,8 +113,11 @@
 #define APP_SCAN_RESP_DATA_MAX_SIZE         (SCAN_RSP_DATA_LEN)
 
 /// Max connections supported by application task
+#ifdef CFG_ENABLE_MULTIPLE_CONN
+#define APP_EASY_MAX_ACTIVE_CONNECTION      (BLE_CONNECTION_MAX)
+#else
 #define APP_EASY_MAX_ACTIVE_CONNECTION      (1)
-
+#endif
 /*
  * TYPE DEFINITIONS
  ****************************************************************************************
@@ -247,6 +250,16 @@ bool app_db_init_start(void);
  */
 bool app_db_init(void);
 
+#if (defined (__DA14531__) && !defined (__EXCLUDE_ROM_APP_TASK__)) || defined (CFG_ENABLE_MULTIPLE_CONN)
+/**
+****************************************************************************************
+* @brief Initialize the database for all the included profiles.
+* @return true if succeeded, else false
+****************************************************************************************
+*/
+bool app_db_init_next(void);
+#endif
+
 /**
  ****************************************************************************************
  * @brief Start a kernel timer.
diff --git a/sdk/app_modules/api/app_task.h b/sdk/app_modules/api/app_task.h
index 57d1aa9..de18e60 100644
--- a/sdk/app_modules/api/app_task.h
+++ b/sdk/app_modules/api/app_task.h
@@ -32,8 +32,11 @@
  */
 
 /// Number of APP Task Instances
-#define APP_IDX_MAX                 (1)
-
+#ifdef CFG_ENABLE_MULTIPLE_CONN
+#define APP_IDX_MAX      (1)
+#else
+#define APP_IDX_MAX      (APP_EASY_MAX_ACTIVE_CONNECTION)
+#endif
 /*
  * ENUMERATIONS
  ****************************************************************************************
diff --git a/sdk/app_modules/src/app_common/app_task.c b/sdk/app_modules/src/app_common/app_task.c
index 6bbb6d4..6b59429 100644
--- a/sdk/app_modules/src/app_common/app_task.c
+++ b/sdk/app_modules/src/app_common/app_task.c
@@ -213,7 +213,7 @@ static int gapm_cmp_evt_handler(ke_msg_id_t const msgid,
  * @return If the message was consumed or not.
  ****************************************************************************************
  */
-static int gapc_connection_req_ind_handler(ke_msg_id_t const msgid,
+__WEAK int gapc_connection_req_ind_handler(ke_msg_id_t const msgid,
                                            struct gapc_connection_req_ind const *param,
                                            ke_task_id_t const dest_id,
                                            ke_task_id_t const src_id)
@@ -310,7 +310,7 @@ static int gapc_cmp_evt_handler(ke_msg_id_t const msgid,
  * @return If the message was consumed or not.
  ****************************************************************************************
  */
-static int gapc_disconnect_ind_handler(ke_msg_id_t const msgid,
+__WEAK int gapc_disconnect_ind_handler(ke_msg_id_t const msgid,
                                        struct gapc_disconnect_ind const *param,
                                        ke_task_id_t const dest_id,
                                        ke_task_id_t const src_id)
diff --git a/sdk/app_modules/src/app_easy/app_easy_msg_utils.c b/sdk/app_modules/src/app_easy/app_easy_msg_utils.c
index f24351f..2371db5 100644
--- a/sdk/app_modules/src/app_easy/app_easy_msg_utils.c
+++ b/sdk/app_modules/src/app_easy/app_easy_msg_utils.c
@@ -37,7 +37,7 @@
  ****************************************************************************************
  */
 
-#define APP_MSG_UTIL_MAX_NUM    (APP_MSG_UTIL_API_LAST_MES - APP_MSG_UTIL_API_MES0 + 1)
+#define APP_MSG_UTIL_MAX_NUM    APP_MSG_UTIL_API_LAST_MES - APP_MSG_UTIL_API_MES0 + 1
 
 /*
  * GLOBAL VARIABLE DEFINITIONS
diff --git a/sdk/common_project_files/da1458x_periph_setup.h b/sdk/common_project_files/da1458x_periph_setup.h
index 699f17c..cd6495b 100644
--- a/sdk/common_project_files/da1458x_periph_setup.h
+++ b/sdk/common_project_files/da1458x_periph_setup.h
@@ -13,7 +13,7 @@
  */
 
 #ifndef _DA1458X_PERIPH_SETUP_H_
-    #define _DA1458X_PERIPH_SETUP_H_
+#define _DA1458X_PERIPH_SETUP_H_
 
 /*
  * DEFINES
diff --git a/sdk/common_project_files/misc/da14531_symbols.txt b/sdk/common_project_files/misc/da14531_symbols.txt
index 3fb45c5..cc35dcc 100644
--- a/sdk/common_project_files/misc/da14531_symbols.txt
+++ b/sdk/common_project_files/misc/da14531_symbols.txt
@@ -1112,8 +1112,8 @@
 0x07f22c19 T attm_svc_create_db_128
 
 ; app_entry_point.c (__EXCLUDE_ROM_APP_TASK__)
-0x07f232a9 T app_entry_point_handler                  
-0x07f232f1 T app_std_process_event     
+;0x07f232a9 T app_entry_point_handler                  
+;0x07f232f1 T app_std_process_event     
 
 ; app_utils.c - (controlled by __EXCLUDE_ROM_APP_UTILS__)
 0x07f23335 T app_get_address_type_ROM
@@ -1126,24 +1126,24 @@
 0x07f23461 T __aeabi_uldivmod
 
 ; app.c (controlled by __EXCLUDE_ROM_APP_TASK__)
-0x07f234c1 T app_db_init_start
-0x07f234dd T app_db_init
-0x07f234e9 T app_easy_gap_confirm
-0x07f23515 T append_device_name                              
-0x07f23539 T app_easy_gap_update_adv_data 
-0x07f23581 T app_easy_gap_disconnect
-0x07f235bd T app_easy_gap_advertise_stop
-0x07f235d9 T active_conidx_to_conhdl
-0x07f23605 T active_conhdl_to_conidx
-0x07f23641 T app_timer_set
-0x07f2365d T app_easy_gap_set_data_packet_length
-0x07f23699 T get_user_prf_srv_perm
-0x07f236c1 T app_set_prf_srv_perm
-0x07f236f1 T prf_init_srv_perm
-0x07f23715 T app_gattc_svc_changed_cmd_send                
+;0x07f234c1 T app_db_init_start
+;0x07f234dd T app_db_init
+;0x07f234e9 T app_easy_gap_confirm
+;0x07f23515 T append_device_name                              
+;0x07f23539 T app_easy_gap_update_adv_data 
+;0x07f23581 T app_easy_gap_disconnect
+;0x07f235bd T app_easy_gap_advertise_stop
+;0x07f235d9 T active_conidx_to_conhdl
+;0x07f23605 T active_conhdl_to_conidx
+;0x07f23641 T app_timer_set
+;0x07f2365d T app_easy_gap_set_data_packet_length
+;0x07f23699 T get_user_prf_srv_perm
+;0x07f236c1 T app_set_prf_srv_perm
+;0x07f236f1 T prf_init_srv_perm
+;0x07f23715 T app_gattc_svc_changed_cmd_send                
 
 ; (controlled by __EXCLUDE_ROM_APP_TASK__)
-0x07f23f58 D app_default_handler
+;0x07f23f58 D app_default_handler
 
 ; (controlled by __EXCLUDE_ROM_GAP_CFG_DATA__)               
 0x07f23f60 D gap_cfg_user_var_struct
-- 
2.39.2.windows.1

